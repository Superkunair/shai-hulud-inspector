# Azure Pipelines - Shai Hulud Security Scan
# File: azure-pipelines.yml
#
# Place this file in the root of your repository
# The pipeline will FAIL if vulnerabilities are detected (exit code 1)

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - package-lock.json
      - package.json

pool:
  vmImage: 'ubuntu-latest'

variables:
  nodeVersion: '18.x'

stages:
  - stage: SecurityScan
    displayName: 'Security Scan'
    jobs:
      - job: ShaiHuludScan
        displayName: 'Shai Hulud Vulnerability Scan'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)
          
          - script: npm ci
            displayName: 'Install dependencies'
          
          - script: npx shai-hulud-inspector@latest
            displayName: 'Run Shai Hulud Scanner'
            # Pipeline fails here if vulnerabilities found (exit 1)
          
          - task: PublishBuildArtifacts@1
            displayName: 'Publish scan results (on failure)'
            condition: failed()
            inputs:
              PathtoPublish: 'package-lock.json'
              ArtifactName: 'security-scan'

  - stage: Build
    displayName: 'Build'
    dependsOn: SecurityScan
    condition: succeeded()
    jobs:
      - job: BuildApp
        displayName: 'Build Application'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: $(nodeVersion)
          
          - script: npm ci
            displayName: 'Install dependencies'
          
          - script: npm run build
            displayName: 'Build application'

# Advanced example with multiple projects
---
trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: SecurityScan
    displayName: 'Security Scan All Projects'
    jobs:
      - job: ScanFrontend
        displayName: 'Scan Frontend'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
          - script: |
              cd frontend
              npm ci
              npx shai-hulud-inspector@latest
            displayName: 'Scan Frontend Dependencies'
      
      - job: ScanBackend
        displayName: 'Scan Backend'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
          - script: |
              cd backend
              npm ci
              npx shai-hulud-inspector@latest
            displayName: 'Scan Backend Dependencies'
      
      - job: ScanAPI
        displayName: 'Scan API'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
          - script: |
              cd api
              npm ci
              npx shai-hulud-inspector@latest
            displayName: 'Scan API Dependencies'

# Example with notifications
---
trigger:
  - main
  - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: security-notifications

stages:
  - stage: SecurityGate
    displayName: 'Security Gate'
    jobs:
      - job: SecurityScan
        displayName: 'Shai Hulud Scan'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
          
          - script: npm ci
            displayName: 'Install dependencies'
          
          - script: |
              echo "Running security scan..."
              if npx shai-hulud-inspector@latest; then
                echo "##vso[task.setvariable variable=scanResult;isOutput=true]passed"
                echo "‚úÖ Security scan passed"
              else
                echo "##vso[task.setvariable variable=scanResult;isOutput=true]failed"
                echo "‚ùå Security scan failed"
                exit 1
              fi
            name: scan
            displayName: 'Run Security Scan'
          
          - task: PowerShell@2
            displayName: 'Send notification on failure'
            condition: failed()
            inputs:
              targetType: 'inline'
              script: |
                $body = @{
                  text = "üö® Shai Hulud vulnerabilities detected in $(Build.Repository.Name)"
                  build = "$(Build.BuildNumber)"
                  branch = "$(Build.SourceBranchName)"
                } | ConvertTo-Json
                
                Invoke-RestMethod -Uri "$(TEAMS_WEBHOOK)" `
                  -Method Post `
                  -Body $body `
                  -ContentType 'application/json'

  - stage: Deploy
    displayName: 'Deploy'
    dependsOn: SecurityGate
    condition: succeeded()
    jobs:
      - deployment: DeployProd
        displayName: 'Deploy to Production'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - script: echo "Deploying to production..."
                  displayName: 'Deploy'

# Example with scheduled scans
---
schedules:
  - cron: "0 2 * * *"
    displayName: Daily security scan
    branches:
      include:
        - main
    always: true

trigger: none

pool:
  vmImage: 'ubuntu-latest'

jobs:
  - job: DailySecurityScan
    displayName: 'Daily Security Scan'
    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '18.x'
      
      - script: npm ci
        displayName: 'Install dependencies'
      
      - script: npx shai-hulud-inspector@latest
        displayName: 'Run security scan'
        continueOnError: false
      
      - task: PublishTestResults@2
        displayName: 'Publish scan results'
        condition: always()
        inputs:
          testResultsFormat: 'JUnit'
          testResultsFiles: '**/scan-results.xml'
          failTaskOnFailedTests: true

